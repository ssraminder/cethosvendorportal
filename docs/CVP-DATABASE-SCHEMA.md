# CETHOS Vendor Portal (CVP) — Database Schema Reference

**Document:** `CVP-DATABASE-SCHEMA.md`
**Version:** 1.0
**Date:** February 18, 2026
**Supabase Project:** lmzoyezvsjgsxveoakdr (shared with portal.cethos.com)

---

## CRITICAL INSTRUCTION FOR CLAUDE CODE

> **Before writing any database-related code:**
> 1. Read this entire document
> 2. Never create a table without a `cvp_` prefix
> 3. Never rename, alter, or touch tables without a `cvp_` prefix — those belong to CETHOS
> 4. Always use `uuid` primary keys with `gen_random_uuid()` default
> 5. Always include `created_at` and `updated_at` timestamptz columns
> 6. Run migrations using Supabase CLI: `supabase db push`
> 7. Update this document whenever you add or change a table

---

## Shared CETHOS Tables Used (Read Only from CVP)

These tables exist in the shared Supabase project. CVP reads them via edge functions only — never writes to them directly.

| Table | Used for |
|---|---|
| `languages` | Language pair selection in application form and test library |
| `staff_users` | Admin authentication — CVP admins log in via existing staff auth |

**Reference: languages table columns used:**
- `id` (uuid)
- `name` (text) — display name e.g. "Spanish"
- `code` (varchar) — ISO code e.g. "es"
- `is_active` (boolean)

---

## CVP Tables

### Table: `cvp_applications`

Primary record for all vendor applications. One row per application submission.

```sql
CREATE TABLE cvp_applications (
  id                          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  application_number          VARCHAR(20) NOT NULL UNIQUE,
    -- Format: APP-YY-NNNN e.g. APP-26-0001
    -- Generated by edge function, not DB trigger
  
  -- Role type
  role_type                   VARCHAR(30) NOT NULL CHECK (role_type IN (
    'translator',
    'cognitive_debriefing'
  )),
  
  -- Personal info
  email                       VARCHAR(255) NOT NULL,
  full_name                   VARCHAR(255) NOT NULL,
  phone                       VARCHAR(50),
  city                        VARCHAR(100),
  country                     VARCHAR(100) NOT NULL,
  linkedin_url                TEXT,
  
  -- Professional background (translator)
  years_experience            INTEGER,
    -- 0=<1, 1, 3, 5, 7, 10 representing the lower bound of each bracket
  education_level             VARCHAR(50),
    -- bachelor, master, phd, diploma_certificate, other
  certifications              JSONB DEFAULT '[]',
    -- [{name: "ATA", expiry_date: "2027-03-01"}, ...]
  cat_tools                   TEXT[] DEFAULT '{}',
    -- ["Trados", "MemoQ", ...]
  services_offered            TEXT[] DEFAULT '{}',
    -- ["translation", "translation_review", "lqa_review"]
  work_samples                JSONB DEFAULT '[]',
    -- [{storage_path: "vendor/samples/...", description: "Legal contract ES→EN"}]
  rate_expectation            DECIMAL(10,2),
    -- Per page, CAD
  referral_source             VARCHAR(100),
  notes                       TEXT,

  -- Professional background (cognitive debriefing specific)
  cog_years_experience        INTEGER,
  cog_degree_field            VARCHAR(200),
  cog_credentials             TEXT,
  cog_instrument_types        TEXT[] DEFAULT '{}',
    -- ["pro", "clinro", "obro", "interview_guide", "survey"]
  cog_therapy_areas           TEXT[] DEFAULT '{}',
  cog_pharma_clients          TEXT,
    -- Stored as plain text, marked confidential in UI
  cog_ispor_familiarity       VARCHAR(20),
    -- yes, no, partially
  cog_fda_familiarity         VARCHAR(20),
  cog_prior_debrief_reports   BOOLEAN DEFAULT FALSE,
  cog_sample_report_path      TEXT,
  cog_availability            VARCHAR(30),
    -- full_time, part_time, project_based
  cog_rate_expectation        DECIMAL(10,2),

  -- Application status
  status                      VARCHAR(40) NOT NULL DEFAULT 'submitted' CHECK (status IN (
    'submitted',
    'prescreening',
    'prescreened',
    'test_pending',
    'test_sent',
    'test_in_progress',
    'test_submitted',
    'test_assessed',
    'negotiation',
    'staff_review',
    'approved',
    'rejected',
    'waitlisted',
    'archived',
    'info_requested'
  )),

  -- AI pre-screening results
  ai_prescreening_score       INTEGER CHECK (ai_prescreening_score BETWEEN 0 AND 100),
  ai_prescreening_result      JSONB,
    -- Full Claude output JSON
  ai_prescreening_at          TIMESTAMPTZ,

  -- Tier assignment
  assigned_tier               VARCHAR(20) CHECK (assigned_tier IN ('standard', 'senior', 'expert')),
  tier_override_by            UUID REFERENCES staff_users(id),
  tier_override_at            TIMESTAMPTZ,

  -- Rate negotiation
  negotiation_status          VARCHAR(30) CHECK (negotiation_status IN (
    'not_needed',
    'pending',
    'offer_sent',
    'accepted',
    'countered',
    'counter_accepted',
    'staff_review',
    'agreed',
    'no_response'
  )),
  negotiation_log             JSONB DEFAULT '[]',
    -- [{event, amount, timestamp, notes}, ...]
  final_agreed_rate           DECIMAL(10,2),
  negotiate_token             UUID UNIQUE,
  negotiate_token_expires_at  TIMESTAMPTZ,

  -- Staff review
  staff_review_notes          TEXT,
  staff_reviewed_by           UUID REFERENCES staff_users(id),
  staff_reviewed_at           TIMESTAMPTZ,

  -- Rejection
  rejection_reason            TEXT,
  rejection_email_draft       TEXT,
    -- AI-generated, staff-editable
  rejection_email_status      VARCHAR(20) DEFAULT 'not_needed' CHECK (rejection_email_status IN (
    'not_needed',
    'queued',
    'sent',
    'intercepted'
  )),
  rejection_email_queued_at   TIMESTAMPTZ,
    -- 48hr window starts here

  -- Reapplication control
  can_reapply_after           DATE,

  -- Account link (set on approval)
  translator_id               UUID,
    -- FK to cvp_translators.id — added after cvp_translators is created

  -- Waitlist
  waitlist_language_pair      VARCHAR(100),
    -- Human-readable e.g. "French → English"
  waitlist_notes              TEXT,

  -- Meta
  ip_address                  VARCHAR(45),
  user_agent                  TEXT,
  created_at                  TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at                  TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_cvp_applications_email ON cvp_applications(email);
CREATE INDEX idx_cvp_applications_status ON cvp_applications(status);
CREATE INDEX idx_cvp_applications_role_type ON cvp_applications(role_type);
CREATE INDEX idx_cvp_applications_created_at ON cvp_applications(created_at DESC);
```

---

### Table: `cvp_test_combinations`

One row per language pair + domain + service type combination per application.
Approval is tracked at this granularity — an applicant can be approved per combination independently.

```sql
CREATE TABLE cvp_test_combinations (
  id                    UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  application_id        UUID NOT NULL REFERENCES cvp_applications(id) ON DELETE CASCADE,
  
  -- Language pair and domain
  source_language_id    UUID NOT NULL REFERENCES languages(id),
  target_language_id    UUID NOT NULL REFERENCES languages(id),
  domain                VARCHAR(50) NOT NULL CHECK (domain IN (
    'legal', 'medical', 'immigration', 'financial', 'technical', 'general'
  )),
  service_type          VARCHAR(30) NOT NULL CHECK (service_type IN (
    'translation',
    'translation_review',
    'lqa_review'
  )),
  
  -- Test assignment
  test_id               UUID,
    -- FK to cvp_test_library.id — set when test is assigned
  test_submission_id    UUID,
    -- FK to cvp_test_submissions.id — set when submission created
  
  -- Status
  status                VARCHAR(30) NOT NULL DEFAULT 'pending' CHECK (status IN (
    'pending',
    'no_test_available',
    'test_assigned',
    'test_sent',
    'test_submitted',
    'assessed',
    'approved',
    'rejected',
    'skipped'
  )),
  
  -- Assessment result
  ai_score              INTEGER CHECK (ai_score BETWEEN 0 AND 100),
  ai_assessment_result  JSONB,
  
  -- Approval
  approved_at           TIMESTAMPTZ,
  approved_by           UUID REFERENCES staff_users(id),
    -- NULL = auto-approved by AI
  approved_rate         DECIMAL(10,2),
    -- Rate agreed for this specific combination
  
  created_at            TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at            TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  -- Prevent duplicate combinations per application
  UNIQUE(application_id, source_language_id, target_language_id, domain, service_type)
);

CREATE INDEX idx_cvp_test_combinations_application ON cvp_test_combinations(application_id);
CREATE INDEX idx_cvp_test_combinations_status ON cvp_test_combinations(status);
```

---

### Table: `cvp_test_library`

Staff-managed library of test documents. One row per test.

```sql
CREATE TABLE cvp_test_library (
  id                          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title                       VARCHAR(255) NOT NULL,
    -- Internal name e.g. "Spanish Legal - Intermediate v2"
  
  -- Test categorisation
  source_language_id          UUID NOT NULL REFERENCES languages(id),
  target_language_id          UUID NOT NULL REFERENCES languages(id),
  domain                      VARCHAR(50) NOT NULL CHECK (domain IN (
    'legal', 'medical', 'immigration', 'financial', 'technical', 'general'
  )),
  service_type                VARCHAR(30) NOT NULL CHECK (service_type IN (
    'translation',
    'translation_review',
    'lqa_review'
  )),
  difficulty                  VARCHAR(20) NOT NULL CHECK (difficulty IN (
    'beginner', 'intermediate', 'advanced'
  )),
  
  -- Test content
  source_text                 TEXT,
    -- The text/passage the applicant sees
  source_file_path            TEXT,
    -- Optional: file version of source text
  instructions                TEXT,
    -- Specific instructions shown to applicant for this test
  
  -- For translation and translation_review tests
  reference_translation       TEXT,
    -- Gold standard translation for AI comparison
  
  -- For lqa_review tests
  lqa_source_translation      TEXT,
    -- The flawed translation applicant must review
  lqa_answer_key              JSONB,
    -- Expected errors and MQM categories
    -- [{category, sub_category, severity, location, description}, ...]
  
  -- MQM configuration
  mqm_dimensions_enabled      TEXT[] DEFAULT ARRAY[
    'accuracy', 'fluency', 'terminology', 
    'style', 'locale_conventions', 'design', 'non_translation'
  ],
  
  -- AI assessment rubric
  ai_assessment_rubric        TEXT,
    -- Additional instructions for Claude when assessing this specific test
  
  -- Usage tracking
  is_active                   BOOLEAN NOT NULL DEFAULT TRUE,
  times_used                  INTEGER NOT NULL DEFAULT 0,
  last_used_at                TIMESTAMPTZ,
  total_pass_count            INTEGER NOT NULL DEFAULT 0,
  total_fail_count            INTEGER NOT NULL DEFAULT 0,
    -- avg_pass_rate calculated as: total_pass_count / (times_used) * 100
  
  -- Ownership
  created_by                  UUID REFERENCES staff_users(id),
  updated_by                  UUID REFERENCES staff_users(id),
  created_at                  TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at                  TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_cvp_test_library_language_domain ON cvp_test_library(
  source_language_id, target_language_id, domain, service_type
);
CREATE INDEX idx_cvp_test_library_active ON cvp_test_library(is_active);
```

---

### Table: `cvp_test_submissions`

One row per test token issued. Tracks the full lifecycle of a test from sending to assessment.

```sql
CREATE TABLE cvp_test_submissions (
  id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  combination_id          UUID NOT NULL REFERENCES cvp_test_combinations(id) ON DELETE CASCADE,
  test_id                 UUID NOT NULL REFERENCES cvp_test_library(id),
  application_id          UUID NOT NULL REFERENCES cvp_applications(id),
    -- Denormalised for easier querying
  
  -- Access token
  token                   UUID NOT NULL UNIQUE DEFAULT gen_random_uuid(),
  token_expires_at        TIMESTAMPTZ NOT NULL,
    -- Set to: created_at + interval '48 hours'
  
  -- Lifecycle status
  status                  VARCHAR(30) NOT NULL DEFAULT 'sent' CHECK (status IN (
    'sent',
    'viewed',
    'draft_saved',
    'submitted',
    'assessed',
    'expired'
  )),
  
  -- Submission
  submitted_file_path     TEXT,
    -- Storage: vendor/tests/{application_id}/{token}.pdf
  submitted_notes         TEXT,
    -- Applicant's notes on their submission
  submitted_at            TIMESTAMPTZ,
  
  -- Draft auto-save
  draft_content           TEXT,
  draft_last_saved_at     TIMESTAMPTZ,
  
  -- AI assessment
  ai_assessment_score     INTEGER CHECK (ai_assessment_score BETWEEN 0 AND 100),
  ai_assessment_result    JSONB,
    -- Full Claude output JSON
  ai_assessed_at          TIMESTAMPTZ,
  
  -- Follow-up email tracking
  reminder_day2_sent_at   TIMESTAMPTZ,
  reminder_day3_sent_at   TIMESTAMPTZ,
  reminder_day7_sent_at   TIMESTAMPTZ,
  
  -- Token first viewed
  first_viewed_at         TIMESTAMPTZ,
  view_count              INTEGER NOT NULL DEFAULT 0,
  
  created_at              TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at              TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_cvp_test_submissions_token ON cvp_test_submissions(token);
CREATE INDEX idx_cvp_test_submissions_application ON cvp_test_submissions(application_id);
CREATE INDEX idx_cvp_test_submissions_status ON cvp_test_submissions(status);
CREATE INDEX idx_cvp_test_submissions_expires ON cvp_test_submissions(token_expires_at)
  WHERE status NOT IN ('submitted', 'assessed', 'expired');
```

---

### Table: `cvp_translators`

Created when an application is approved. The primary vendor record.

```sql
CREATE TABLE cvp_translators (
  id                          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- Auth link
  auth_user_id                UUID UNIQUE,
    -- FK to Supabase auth.users — set when invite is accepted
  
  -- Source
  application_id              UUID REFERENCES cvp_applications(id),
    -- The application that led to this account
  
  -- Identity
  email                       VARCHAR(255) NOT NULL UNIQUE,
  full_name                   VARCHAR(255) NOT NULL,
  phone                       VARCHAR(50),
  country                     VARCHAR(100),
  linkedin_url                TEXT,
  
  -- Role
  role_type                   VARCHAR(30) NOT NULL CHECK (role_type IN (
    'translator',
    'cognitive_debriefing'
  )),
  tier                        VARCHAR(20) CHECK (tier IN ('standard', 'senior', 'expert')),
    -- NULL for cognitive_debriefing
  
  -- Approved work scope
  approved_combinations       JSONB DEFAULT '[]',
    -- [{
    --   source_language_id, target_language_id,
    --   domain, service_type,
    --   approved_at, approved_rate,
    --   combination_id
    -- }]
  
  -- Profile
  profile_photo_url           TEXT,
  bio                         TEXT,
  certifications              JSONB DEFAULT '[]',
    -- [{name, expiry_date, verified: bool}]
  cat_tools                   TEXT[] DEFAULT '{}',
  
  -- Cognitive debriefing specific
  cog_instrument_types        TEXT[] DEFAULT '{}',
  cog_therapy_areas           TEXT[] DEFAULT '{}',
  cog_ispor_familiarity       VARCHAR(20),
  cog_fda_familiarity         VARCHAR(20),
  
  -- Rates
  default_rate                DECIMAL(10,2),
    -- Default per-page rate (CAD)
  
  -- Payout
  payout_method               VARCHAR(30) CHECK (payout_method IN (
    'bank_transfer', 'paypal', 'cheque', 'e_transfer'
  )),
  payout_details              JSONB,
    -- Stored as encrypted JSON — bank details, PayPal email, etc.
    -- NEVER log this field
  
  -- Account status
  is_active                   BOOLEAN NOT NULL DEFAULT TRUE,
  deactivated_at              TIMESTAMPTZ,
  deactivated_by              UUID REFERENCES staff_users(id),
  deactivation_reason         TEXT,
  
  -- Profile completeness (0–100, recalculated on profile updates)
  profile_completeness        INTEGER NOT NULL DEFAULT 0,
  
  -- Performance stats (updated by cron/triggers after Phase 2 jobs)
  total_jobs_completed        INTEGER NOT NULL DEFAULT 0,
  average_performance_score   DECIMAL(4,2),
    -- Rolling average of per-job scores (Phase 2)
  last_active_at              TIMESTAMPTZ,
    -- Last job claimed or submitted
  
  -- Language pairs last reviewed (for health check nudge)
  language_pairs_reviewed_at  TIMESTAMPTZ,
  
  -- Invite status
  invite_sent_at              TIMESTAMPTZ,
  invite_accepted_at          TIMESTAMPTZ,
  
  created_at                  TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at                  TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_cvp_translators_email ON cvp_translators(email);
CREATE INDEX idx_cvp_translators_active ON cvp_translators(is_active);
CREATE INDEX idx_cvp_translators_role_type ON cvp_translators(role_type);
CREATE INDEX idx_cvp_translators_tier ON cvp_translators(tier);
CREATE INDEX idx_cvp_translators_completeness ON cvp_translators(profile_completeness);
CREATE INDEX idx_cvp_translators_last_active ON cvp_translators(last_active_at);
```

---

### Table: `cvp_profile_nudges`

Tracks which profile health nudges have been sent to each translator.
Prevents repeat emails within the 30-day suppression window.

```sql
CREATE TABLE cvp_profile_nudges (
  id                UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  translator_id     UUID NOT NULL REFERENCES cvp_translators(id) ON DELETE CASCADE,
  
  nudge_type        VARCHAR(50) NOT NULL CHECK (nudge_type IN (
    'payout_missing',
    'profile_incomplete',
    'certification_expiry',
    'language_pairs_stale',
    'inactive_internal'
      -- Note: inactive_internal does NOT send an email — staff flag only
  )),
  
  -- Email tracking (null for internal-only nudges)
  email_sent_at     TIMESTAMPTZ,
  email_template    VARCHAR(10),
    -- e.g. "V14", "V15"
  
  -- Suppression
  suppressed_until  TIMESTAMPTZ,
    -- Set to: email_sent_at + interval '30 days'
  
  -- Resolution
  resolved_at       TIMESTAMPTZ,
    -- Set automatically when the issue is fixed
  resolved_notes    TEXT,
  
  -- Escalation tracking (for payout_missing)
  escalation_level  INTEGER DEFAULT 1,
    -- 1=initial nudge, 2=14-day reminder, 3=30-day staff alert
  
  created_at        TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_cvp_profile_nudges_translator ON cvp_profile_nudges(translator_id);
CREATE INDEX idx_cvp_profile_nudges_type ON cvp_profile_nudges(nudge_type);
CREATE INDEX idx_cvp_profile_nudges_unresolved ON cvp_profile_nudges(translator_id, nudge_type)
  WHERE resolved_at IS NULL;
```

---

## RLS Policies

### Public access (no auth) — for application form and test pages

```sql
-- Allow public to submit applications
CREATE POLICY "Public can submit applications"
  ON cvp_applications FOR INSERT
  TO anon
  WITH CHECK (true);

-- Allow token-based access to test submissions
-- Edge function uses service_role key — no RLS needed for cvp-get-test
-- Client never queries cvp_test_submissions directly
```

### Staff access — via existing staff_users auth

```sql
-- Staff can read all CVP tables
CREATE POLICY "Staff can read cvp_applications"
  ON cvp_applications FOR SELECT
  TO authenticated
  USING (
    EXISTS (SELECT 1 FROM staff_users WHERE auth_user_id = auth.uid() AND is_active = TRUE)
  );

CREATE POLICY "Staff can update cvp_applications"
  ON cvp_applications FOR UPDATE
  TO authenticated
  USING (
    EXISTS (SELECT 1 FROM staff_users WHERE auth_user_id = auth.uid() AND is_active = TRUE)
  );

-- Similar policies for cvp_test_library, cvp_translators, etc.
```

### Translator access (Phase 2) — vendors see only their own data

```sql
-- Translators can only see their own record
CREATE POLICY "Translators see own record"
  ON cvp_translators FOR SELECT
  TO authenticated
  USING (auth_user_id = auth.uid());

-- Translators can update their own profile
CREATE POLICY "Translators update own profile"
  ON cvp_translators FOR UPDATE
  TO authenticated
  USING (auth_user_id = auth.uid())
  WITH CHECK (auth_user_id = auth.uid());
```

---

## Storage Structure

All CVP files stored in the existing `quote-files` Supabase storage bucket under a `vendor/` prefix:

```
quote-files/
├── vendor/
│   ├── samples/                    ← Work samples uploaded with applications
│   │   └── {application_id}/
│   │       └── {filename}
│   ├── tests/                      ← Test submission files
│   │   └── {application_id}/
│   │       └── {token}/
│   │           └── {filename}
│   ├── debrief_samples/            ← Cognitive debriefing sample reports
│   │   └── {application_id}/
│   │       └── {filename}
│   └── profiles/                   ← Translator profile photos (Phase 2)
│       └── {translator_id}/
│           └── avatar.{ext}
```

---

## Migration Order

Run migrations in this order to respect foreign key dependencies:

1. `001_cvp_test_library.sql` — no external dependencies
2. `002_cvp_applications.sql` — depends on staff_users, languages
3. `003_cvp_test_combinations.sql` — depends on cvp_applications, languages, cvp_test_library
4. `004_cvp_test_submissions.sql` — depends on cvp_test_combinations, cvp_test_library, cvp_applications
5. `005_cvp_translators.sql` — depends on cvp_applications, staff_users
6. `006_cvp_profile_nudges.sql` — depends on cvp_translators
7. `007_cvp_rls_policies.sql` — depends on all above
8. `008_cvp_add_translator_fk.sql` — adds FK from cvp_applications to cvp_translators (circular, added last)

```sql
-- 008: Add translator FK after both tables exist
ALTER TABLE cvp_applications
  ADD CONSTRAINT fk_cvp_applications_translator
  FOREIGN KEY (translator_id) REFERENCES cvp_translators(id);
```

---

## Phase 2 Tables (Documented for Schema Planning — Not Built Yet)

### `cvp_jobs` (Phase 2)

```sql
-- Placeholder — do not build until Phase 2 is approved
-- cvp_jobs: one row per vendor job assignment
-- Links orders (CETHOS) to translators (CVP) via edge functions
-- Columns: id, job_number, order_id (CETHOS ref), translator_id,
--   source_language_id, target_language_id, domain, status,
--   is_on_job_board, deadline, instructions, fee, fee_basis,
--   page_count, word_count, assignment_method, claimed_at,
--   accepted_at, submitted_at, approved_at, etc.
```

### `cvp_job_messages` (Phase 2)

```sql
-- Per-job messaging between translator and staff
-- Columns: id, job_id, sender_type (translator/staff),
--   sender_id, message, is_read, created_at
```

### `cvp_payments` (Phase 2)

```sql
-- Payout tracking per translator
-- Columns: id, translator_id, job_id, amount, status,
--   period_start, period_end, payment_method,
--   payment_reference, paid_at, paid_by, notes
```

---

*End of CVP-DATABASE-SCHEMA.md*
